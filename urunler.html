<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGTEK – Ürünler</title>
  <meta name="description" content="DMO onaylı ürünler kataloğu">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/urunler.css">
  <style>
    /* Modal başlangıçta kapalı */
    [hidden]{display:none!important}
    .overlay{display:none}
    .overlay.is-open{display:grid}
  </style>
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="container header__inner">
      <a class="brand" href="index.html" aria-label="SGTEK Ana Sayfa">
        <img src="img/sgtlogo.png" alt="SGTEK logo">
      </a>
      <nav class="nav" aria-label="Ana menü">
        <a href="index.html">Ana Sayfa</a>
        <a href="Kurumsal">Kurumsal</a>
        <a href="Siber Güvenlik">Siber Güvenlik</a>
        <a href="urunler.html" aria-current="page">Ürünler</a>
        <a href="#iletisim" onclick="document.getElementById('footer-contact').scrollIntoView({behavior:'smooth'});return false;">İletişim</a>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="section">
    <div class="container">
      <h1 class="pg-title">DMO ÜRÜN LİSTESİ</h1>

      <div class="searchbar">
        <input id="searchInput" type="search" placeholder="Ürün adı veya marka ara..." aria-label="Ürün ara">
      </div>

      <div id="productGrid" class="product-grid" aria-live="polite"></div>
      <div id="productEmpty" class="product-empty" hidden>Ürün bulunamadı.</div>
      <div id="debugBox" class="product-empty" hidden style="margin-top:18px"></div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer" id="footer-contact">
    <div class="container footer__inner">
      <p>© <span id="yil"></span> SGTEK Tüm Hakları Saklıdır</p>
      <nav class="footer__nav">
        <a href="#Çerezler">Çerezler</a>
        <a href="#">KVKK</a>
        <a href="#">Gizlilik</a>
        <a href="#">Kullanım Şartları</a>
      </nav>
    </div>
  </footer>

  <!-- GALERİ MODAL -->
  <div id="galleryOverlay" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal__hdr">
        <h3 id="modalTitle"></h3>
        <button id="modalClose" class="modal__close" aria-label="Kapat">×</button>
      </div>
      <div class="modal__main">
        <div class="viewer"><img id="modalMain" alt=""></div>
        <div id="thumbs" class="thumbs"></div>
        <div class="modal__meta">
          <p id="modalBrand" class="brand"></p>
          <a id="modalDmo" class="btn btn--dmo" href="#" target="_blank" rel="noopener" hidden>DMO’ya Git</a>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Footer yılı
    document.getElementById('yil').textContent = new Date().getFullYear();

    /* ======= Google Sheets (CSV) ======= */
    const SHEET_ID  = "1RtHLgzmaAsjNfQM79b5jy4kkaRbPFdMznbO3kktr3Ng";
    const SHEET_GID = "0"; // ilk sekme
    const CSV_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

    // GENEL normalize (tarayıcı uyumlu) + Türkçe düzeltmeleri
    function normalize(s){
      return (s||"")
        .toString()
        .replace(/\u00A0/g,' ')       // NBSP -> boşluk
        .trim()
        .replace(/\s+/g,' ')
        .toLowerCase()
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g,'') // diacritics temizle
        .replace(/ı/g,'i')              // TR özel: ı -> i
        .replace(/İ/g,'i');             // nadiren kalan büyük İ
    }

    // Basit CSV ayrıştırıcı (tırnaklı alan destekli)
    function parseCSV(text){
      const rows=[]; let row=[], val="", inQ=false;
      for(let i=0;i<text.length;i++){
        const ch=text[i], nx=text[i+1];
        if(inQ){
          if(ch=='"' && nx=='"'){ val+='"'; i++; }
          else if(ch=='"'){ inQ=false; }
          else { val+=ch; }
        }else{
          if(ch=='"'){ inQ=true; }
          else if(ch==','){ row.push(val); val=""; }
          else if(ch=='\n'){ row.push(val); rows.push(row); row=[]; val=""; }
          else if(ch=='\r'){ /* ignore */ }
          else { val+=ch; }
        }
      }
      row.push(val); rows.push(row);
      return rows.filter(r => r.some(c => normalize(c)!==""));
    }

    // Senin başlıklarına göre tespit
    function detectColumns(headers){
      const H = headers.map(normalize);
      // "ürün adı" artık "urun adi"ya normalize olur (ı -> i)
      const title = H.findIndex(h => h === "urun adi");
      const brand = H.findIndex(h => h === "marka");
      const dmo   = H.findIndex(h => h === "dmo link");
      const photos = [];
      H.forEach((h,i)=>{ if(h.startsWith("foto")) photos.push(i); });
      return { title, brand, dmo, photos };
    }

    async function fetchCSV(){
      const r = await fetch(CSV_URL, {cache:"no-store"});
      if(!r.ok) throw new Error("CSV HTTP " + r.status);
      const rows = parseCSV(await r.text());
      if(!rows.length) return [];

      const idx = detectColumns(rows[0]);
      if(idx.title < 0) throw new Error('Başlık kolonu ("Ürün Adı") bulunamadı');

      const items=[];
      for(let i=1;i<rows.length;i++){
        const c = rows[i];
        const title = (c[idx.title] || "").toString().trim();
        if(!title) continue;
        const brand = idx.brand>=0 ? (c[idx.brand] || "").toString().trim() : "";
        const dmo   = idx.dmo  >=0 ? (c[idx.dmo]   || "").toString().trim() : "";
        const photos=[];
        for(const pi of idx.photos){
          const v = (c[pi]||"").toString().trim();
          if(v) photos.push(v);
        }
        items.push({title, brand, dmo, photos});
      }
      return items;
    }

    // RENDER
    function renderProducts(items){
      const grid  = document.getElementById("productGrid");
      const empty = document.getElementById("productEmpty");
      grid.innerHTML = "";
      if(!items.length){ empty.hidden=false; return; }
      empty.hidden = true;

      const frag = document.createDocumentFragment();
      items.forEach(it=>{
        const card = document.createElement("article");
        card.className = "product-card";

        const imgBtn = document.createElement("button");
        imgBtn.type = "button";
        imgBtn.className = "imgwrap";
        imgBtn.title = "Görselleri aç";
        imgBtn.setAttribute("aria-label","Görselleri aç");
        const first = (it.photos && it.photos[0]) || "";
        if(first){
          const img = document.createElement("img");
          img.src = first; img.alt = it.title; img.loading="lazy";
          imgBtn.appendChild(img);
        }else{
          imgBtn.classList.add("noimg");
          imgBtn.textContent = "No Image";
        }
        imgBtn.addEventListener("click", ()=>openGallery(it));
        card.appendChild(imgBtn);

        const h3 = document.createElement("h3");
        h3.textContent = it.title;
        card.appendChild(h3);

        if(it.brand){
          const p = document.createElement("p");
          p.className = "brand";
          p.innerHTML = `<strong>Marka:</strong> ${it.brand.toUpperCase()}`;
          card.appendChild(p);
        }

        if(it.dmo){
          const a = document.createElement("a");
          a.href = it.dmo; a.target = "_blank"; a.rel="noopener";
          a.className = "btn btn--dmo";
          a.textContent = "DMO’ya Git";
          card.appendChild(a);
        }

        frag.appendChild(card);
      });
      grid.appendChild(frag);
    }

    function wireSearch(items){
      const input = document.getElementById("searchInput");
      input.addEventListener("input", ()=>{
        const q = input.value.trim().toLowerCase();
        const f = !q ? items : items.filter(it =>
          it.title.toLowerCase().includes(q) ||
          (it.brand||"").toLowerCase().includes(q)
        );
        renderProducts(f);
      });
    }

    // MODAL
    const overlay   = document.getElementById("galleryOverlay");
    const modalMain = document.getElementById("modalMain");
    const modalTtl  = document.getElementById("modalTitle");
    const modalBrd  = document.getElementById("modalBrand");
    const modalDmo  = document.getElementById("modalDmo");
    const thumbsEl  = document.getElementById("thumbs");
    const btnClose  = document.getElementById("modalClose");

    function openOverlay(){
      overlay.classList.add("is-open");
      overlay.removeAttribute("hidden");
      document.body.style.overflow="hidden";
    }
    function closeGallery(){
      overlay.classList.remove("is-open");
      overlay.setAttribute("hidden","");
      document.body.style.overflow="";
    }

    function openGallery(item){
      modalTtl.textContent = item.title;
      modalBrd.textContent = item.brand ? `Marka: ${item.brand}` : "";
      if(item.dmo){ modalDmo.href=item.dmo; modalDmo.hidden=false; } else { modalDmo.hidden=true; }

      thumbsEl.innerHTML = "";
      const photos = (item.photos||[]).filter(Boolean);
      if(photos.length){
        setMain(photos[0], null);
        photos.forEach(src=>{
          const t=document.createElement("button");
          t.type="button"; t.className="thumb";
          t.innerHTML=`<img src="${src}" alt="">`;
          t.addEventListener("click",()=>setMain(src,t));
          thumbsEl.appendChild(t);
        });
        if(thumbsEl.firstElementChild) thumbsEl.firstElementChild.classList.add("active");
      }else{
        setMain("", null);
        thumbsEl.innerHTML = '<div class="thumb thumb--empty">Fotoğraf yok</div>';
      }
      openOverlay();
    }

    function setMain(src, btn){
      if(src){ modalMain.src = src; modalMain.alt = "Ürün görseli"; }
      else   { modalMain.removeAttribute("src"); modalMain.alt=""; }
      Array.prototype.forEach.call(thumbsEl.children, el=>el.classList.remove("active"));
      if(btn) btn.classList.add("active");
    }

    btnClose.addEventListener("click", closeGallery);
    overlay.addEventListener("click", e=>{ if(e.target===overlay) closeGallery(); });
    document.addEventListener("keydown", e=>{ if(!overlay.hidden && e.key==="Escape") closeGallery(); });

    // BAŞLAT
    (async function init(){
      try{
        const items = await fetchCSV();
        renderProducts(items);
        wireSearch(items);
      }catch(err){
        console.error(err);
        const dbg=document.getElementById("debugBox");
        dbg.hidden=false;
        dbg.innerHTML = `
          Ürünler yüklenemedi.<br>
          <small style="color:#6b7280">Hata: ${String(err.message||err).replace(/</g,'&lt;')}</small>
          <div style="margin-top:6px">
            <a target="_blank" href="${CSV_URL}">CSV test</a>
          </div>
        `;
        document.getElementById("productEmpty").hidden=false;
      }
    })();
  </script>
</body>
</html>
