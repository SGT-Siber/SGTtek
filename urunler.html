<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SGTEK – Ürünler</title>
  <meta name="description" content="DMO onaylı ürünler kataloğu">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/urunler.css">
</head>
<body>
  <!-- HEADER -->
  <header class="header">
    <div class="container header__inner">
      <a class="brand" href="index.html" aria-label="SGTEK Ana Sayfa">
        <img src="img/sgtlogo.png" alt="SGTEK logo">
      </a>
      <nav class="nav" aria-label="Ana menü">
        <a href="index.html">Ana Sayfa</a>
        <a href="Kurumsal">Kurumsal</a>
        <a href="Siber Güvenlik">Siber Güvenlik</a>
        <a href="urunler.html" aria-current="page">Ürünler</a>
        <a href="#iletisim" onclick="document.getElementById('footer-contact').scrollIntoView({behavior:'smooth'});return false;">İletişim</a>
      </nav>
    </div>
  </header>

  <!-- MAIN -->
  <main class="section">
    <div class="container">
      <h1 class="pg-title">DMO ÜRÜN LİSTESİ</h1>

      <!-- Arama -->
      <div class="searchbar">
        <input id="searchInput" type="search" placeholder="Ürün adı, marka, cinsi, DMO kodu veya açıklama ara..." aria-label="Ürün ara">
      </div>

      <!-- Sıralama + Sayfa boyutu -->
      <div class="toolbar">
        <div class="toolbar__right">
          <label class="tool">
            <span>Sırala:</span>
            <select id="sortSelect">
              <option value="">Varsayılan</option>
              <option value="priceAsc">Fiyat (Artan)</option>
              <option value="priceDesc">Fiyat (Azalan)</option>
              <option value="brandAsc">Marka (A→Z)</option>
              <option value="brandDesc">Marka (Z→A)</option>
            </select>
          </label>
          <label class="tool">
            <span>Sayfa:</span>
            <select id="pageSizeSelect">
              <option>8</option>
              <option selected>12</option>
              <option>16</option>
              <option>24</option>
            </select>
          </label>
        </div>
      </div>

      <!-- Ürünler -->
      <div id="productGrid" class="product-grid" aria-live="polite"></div>
      <div id="productEmpty" class="product-empty" hidden>Ürün bulunamadı.</div>

      <!-- Pager -->
      <div id="pager" class="pager"></div>

      <div id="debugBox" class="product-empty" hidden style="margin-top:18px"></div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer class="footer" id="footer-contact">
    <div class="container footer__inner">
      <p>© <span id="yil"></span> SGTEK Tüm Hakları Saklıdır</p>
      <nav class="footer__nav">
        <a href="#Çerezler">Çerezler</a>
        <a href="#">KVKK</a>
        <a href="#">Gizlilik</a>
        <a href="#">Kullanım Şartları</a>
      </nav>
    </div>
  </footer>

  <!-- GALERİ MODAL -->
  <div id="galleryOverlay" class="overlay" hidden>
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modal__hdr">
        <h3 id="modalTitle"></h3>
        <button id="modalClose" class="modal__close" aria-label="Kapat">×</button>
      </div>
      <div class="modal__main">
        <div class="viewer"><img id="modalMain" alt=""></div>
        <div id="thumbs" class="thumbs"></div>
        <div class="modal__meta">
          <p id="modalBrand" class="md-row"></p>
          <p id="modalType"  class="md-row"></p>
          <p id="modalDmoCode" class="md-row"></p>
          <p id="modalPrice" class="md-price-main"></p>
          <p id="modalPriceSub" class="md-price-sub"></p>
          <p id="modalDesc" class="desc" style="-webkit-line-clamp:unset;"></p>
          <a id="modalDmo" class="btn btn--dmo" href="#" target="_blank" rel="noopener" hidden>DMO’ya Git</a>
        </div>
      </div>
    </div>
  </div>

<script>
  document.getElementById('yil').textContent = new Date().getFullYear();

  /* ====== Google Sheets (CSV) ====== */
  const SHEET_ID  = "1RtHLgzmaAsjNfQM79b5jy4kkaRbPFdMznbO3kktr3Ng";
  const SHEET_GID = "0";
  const CSV_URL   = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;

  // Fallback görsel (SVG)
  const FALLBACK_IMG = 'data:image/svg+xml;utf8,' + encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="500">
      <rect width="100%" height="100%" fill="#e5e7eb"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
            font-family="Segoe UI, Arial, sans-serif" font-size="24" fill="#6b7280">Görsel yok</text>
    </svg>`);

  const withFallback = (img) => { img.onerror = () => { img.onerror = null; img.src = FALLBACK_IMG; }; };

  function normalize(s){
    return (s||"").toString()
      .replace(/\u00A0/g,' ')
      .trim().replace(/\s+/g,' ')
      .toLowerCase().normalize('NFD')
      .replace(/[\u0300-\u036f]/g,'')
      .replace(/ı/g,'i').replace(/İ/g,'i');
  }

  function parseCSV(text){
    const rows=[]; let row=[], val="", inQ=false;
    for(let i=0;i<text.length;i++){
      const ch=text[i], nx=text[i+1];
      if(inQ){
        if(ch=='"' && nx=='"'){ val+='"'; i++; }
        else if(ch=='"'){ inQ=false; }
        else { val+=ch; }
      }else{
        if(ch=='"'){ inQ=true; }
        else if(ch==','){ row.push(val); val=""; }
        else if(ch=='\n'){ row.push(val); rows.push(row); row=[]; val=""; }
        else if(ch=='\r'){ }
        else { val+=ch; }
      }
    }
    row.push(val); rows.push(row);
    return rows.filter(r=>r.some(c=>normalize(c)!==""));
  }

  function detectColumns(headers){
    const H=headers.map(normalize);
    const hasAll=(h,subs)=>subs.every(s=>h.includes(s));
    const find=(cands)=>{ for(const cand of cands){
      for(let i=0;i<H.length;i++){ const h=H[i];
        if(Array.isArray(cand)?hasAll(h,cand):(h===cand||h.includes(cand))) return i; }
    } return -1; };

    const title   = find([["urun","ad"],["urun","adi"],["urun","baslik"],"title","product"]);
    const brand   = find(["marka","brand","uretici","manufacturer"]);
    const type    = find(["cinsi","tur","tür"]);
    const desc    = find(["urun aciklama","aciklama","açiklama","aciklamasi","açiklamasi"]);
    const dmoCode = find([["dmo","kod"],["dmo","kodu"]]);
    const price   = find([["fiyat"],["price"]]);
    const priceKdv= find([["kdv","dahil"],["fiyat","kdv"],["vat","incl"],["kdv","dahili"]]);
    const dmoLink = find([["dmo","link"],["dmo","url"],["dmo","baglanti"]]);

    const photos=[]; H.forEach((h,i)=>{ if(h.startsWith("foto")||h.startsWith("resim")||h.startsWith("image")) photos.push(i); });

    return { title, brand, type, desc, dmoCode, price, priceKdv, dmoLink, photos };
  }

  // "1.200,00" → 1200
  function toNumPrice(raw){
    if(raw==null) return NaN;
    let t=String(raw).replace(/\s/g,'').replace(/[^\d,.\-]/g,'');
    // 1.234.567,89  →  1234567.89
    t=t.replace(/\./g,'').replace(',', '.');
    const n=parseFloat(t);
    return Number.isFinite(n)?n:NaN;
  }

  const fmtTRY = v=>{
    const num=Number(String(v).replace(/[^\d.,-]/g,'').replace(',','.'));
    if(!isFinite(num)) return "";
    return new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:2}).format(num);
  };
  const short=(t,n=180)=>!t?"":(String(t).trim().length>n?String(t).trim().slice(0,n-1)+"…":String(t).trim());

  async function fetchCSV(){
    const r=await fetch(CSV_URL,{cache:"no-store"});
    if(!r.ok) throw new Error("CSV HTTP "+r.status);
    const rows=parseCSV(await r.text());
    if(!rows.length) return [];
    const idx=detectColumns(rows[0]);
    if(idx.title<0) throw new Error('Başlık kolonu ("Ürün Adı" / "Ürün Başlığı") bulunamadı');

    const items=[];
    for(let i=1;i<rows.length;i++){
      const c=rows[i];
      const title=(c[idx.title]||"").toString().trim(); if(!title) continue;
      const brand=idx.brand>=0?(c[idx.brand]||"").toString().trim():"";
      const type =idx.type >=0?(c[idx.type ]||"").toString().trim():"";
      const desc =idx.desc >=0?(c[idx.desc ]||"").toString().trim():"";
      const dmoCode=idx.dmoCode>=0?(c[idx.dmoCode]||"").toString().trim():"";
      const price  =(idx.price  >=0?(c[idx.price]  ||"").toString().trim():"");
      const priceKdv=(idx.priceKdv>=0?(c[idx.priceKdv]||"").toString().trim():"");
      const dmo   =idx.dmoLink>=0?(c[idx.dmoLink]||"").toString().trim():"";

      const pnumK=toNumPrice(priceKdv);
      const pnum =toNumPrice(price);
      const sortPrice = Number.isFinite(pnumK)?pnumK:(Number.isFinite(pnum)?pnum:NaN);

      const photos=[]; for(const pi of idx.photos){ const v=(c[pi]||"").toString().trim(); if(v) photos.push(v); }
      items.push({title,brand,type,desc,dmoCode,price,priceKdv,dmo,photos,sortPrice});
    }
    return items;
  }

  /* ====== RENDER & DURUM ====== */
  let ALL_ITEMS = [];
  let VIEW_ITEMS = [];
  const STATE = { q:'', sort:'', page:1, pageSize:12 };

  function renderProducts(items){
    const grid=document.getElementById("productGrid");
    const empty=document.getElementById("productEmpty");
    grid.innerHTML=""; if(!items.length){empty.hidden=false;return;} empty.hidden=true;

    const frag=document.createDocumentFragment();
    items.forEach(it=>{
      const card=document.createElement("article");
      card.className="product-card";

      const imgBtn=document.createElement("button");
      imgBtn.type="button"; imgBtn.className="imgwrap";
      imgBtn.title="Görselleri aç"; imgBtn.setAttribute("aria-label","Görselleri aç");
      const first=(it.photos&&it.photos[0])||"";
      if(first){
        const img=document.createElement("img");
        img.src=first; img.alt=it.title; img.loading="lazy"; withFallback(img);
        imgBtn.appendChild(img);
      }else{
        imgBtn.classList.add("noimg"); imgBtn.textContent="No Image";
      }
      imgBtn.addEventListener("click",()=>openGallery(it));
      card.appendChild(imgBtn);

      const body=document.createElement("div"); body.className="card-body"; card.appendChild(body);

      const h3=document.createElement("h3"); h3.textContent=it.title; body.appendChild(h3);

      if(it.brand){
        const p=document.createElement("p"); p.className="brand-line";
        p.innerHTML=`<span class="brand-label">Marka:</span>${it.brand}`; body.appendChild(p);
      }

      const ul=document.createElement("ul"); ul.className="meta";
      if(it.type)    ul.innerHTML+=`<li><span class="label">Cinsi:</span><span class="emph">${it.type}</span></li>`;
      if(it.dmoCode) ul.innerHTML+=`<li><span class="label">DMO Kodu:</span><span class="code">${it.dmoCode}</span></li>`;
      body.appendChild(ul);

      if(it.desc){ const p=document.createElement("p"); p.className="desc"; p.textContent=short(it.desc); body.appendChild(p); }

      if(it.price||it.priceKdv){
        const f1=it.price?fmtTRY(it.price):""; const f2=it.priceKdv?fmtTRY(it.priceKdv):"";
        if(f1||f2){
          const wrap=document.createElement("div"); wrap.className="price-wrap";
          if(f1) wrap.innerHTML+=`<div class="price-main">${f1}</div>`;
          if(f2) wrap.innerHTML+=`<div class="price-sub">KDV Dahil: ${f2}</div>`;
          body.appendChild(wrap);
        }
      }

      if(it.dmo){
        const row=document.createElement("div"); row.className="btn-row";
        const a=document.createElement("a"); a.href=it.dmo; a.target="_blank"; a.rel="noopener";
        a.className="btn btn--dmo"; a.textContent="DMO’ya Git"; row.appendChild(a);
        body.appendChild(row);
      }

      frag.appendChild(card);
    });
    grid.appendChild(frag);
  }

  function renderPager(totalPages){
    const el = document.getElementById('pager');
    if(totalPages<=1){ el.innerHTML=''; return; }
    const makeBtn=(label, page, disabled=false, active=false)=>{
      const b=document.createElement('button');
      b.textContent=label;
      b.disabled=disabled;
      b.className='page-btn'+(active?' is-active':'');
      if(!disabled && !active) b.addEventListener('click', ()=>{ STATE.page=page; update(); });
      return b;
    };
    const t = totalPages;
    const p = STATE.page;

    el.innerHTML='';
    el.appendChild(makeBtn('‹ Önceki', Math.max(1,p-1), p===1));
    const start = Math.max(1, p-2);
    const end   = Math.min(t, p+2);
    for(let i=start;i<=end;i++) el.appendChild(makeBtn(String(i), i, false, i===p));
    el.appendChild(makeBtn('Sonraki ›', Math.min(t,p+1), p===t));
  }

  function applySort(items){
    const arr = items.slice();
    switch(STATE.sort){
      case 'priceAsc':
        return arr.sort((a,b)=>(Number.isFinite(a.sortPrice)?a.sortPrice:Infinity) - (Number.isFinite(b.sortPrice)?b.sortPrice:Infinity));
      case 'priceDesc':
        return arr.sort((a,b)=>(Number.isFinite(b.sortPrice)?b.sortPrice:-Infinity) - (Number.isFinite(a.sortPrice)?a.sortPrice:-Infinity));
      case 'brandAsc':
        return arr.sort((a,b)=> (a.brand||'').localeCompare(b.brand||'', 'tr', {sensitivity:'base'}));
      case 'brandDesc':
        return arr.sort((a,b)=> (b.brand||'').localeCompare(a.brand||'', 'tr', {sensitivity:'base'}));
      default:
        return arr; // varsayılan sıralama
    }
  }

  function update(){
    // filtreleme
    const q = STATE.q.toLowerCase();
    VIEW_ITEMS = !q ? ALL_ITEMS : ALL_ITEMS.filter(it =>
      it.title.toLowerCase().includes(q) ||
      (it.brand||'').toLowerCase().includes(q) ||
      (it.type||'').toLowerCase().includes(q) ||
      (it.dmoCode||'').toLowerCase().includes(q) ||
      (it.desc||'').toLowerCase().includes(q)
    );

    // sıralama
    VIEW_ITEMS = applySort(VIEW_ITEMS);

    // sayfalama
    const totalPages = Math.max(1, Math.ceil(VIEW_ITEMS.length / STATE.pageSize));
    if(STATE.page > totalPages) STATE.page = totalPages;
    const start = (STATE.page - 1) * STATE.pageSize;
    const end   = start + STATE.pageSize;
    renderProducts(VIEW_ITEMS.slice(start,end));
    renderPager(totalPages);
  }

  function wireUI(items){
    const input=document.getElementById("searchInput");
    input.addEventListener("input", ()=>{ STATE.q=input.value.trim(); STATE.page=1; update(); });

    const sortSel = document.getElementById('sortSelect');
    sortSel.addEventListener('change', ()=>{ STATE.sort=sortSel.value; STATE.page=1; update(); });

    const sizeSel = document.getElementById('pageSizeSelect');
    sizeSel.addEventListener('change', ()=>{ STATE.pageSize=parseInt(sizeSel.value,10)||12; STATE.page=1; update(); });
  }

  /* ===== Modal ===== */
  const overlay=document.getElementById("galleryOverlay");
  const modalMain=document.getElementById("modalMain");
  const modalTtl=document.getElementById("modalTitle");
  const modalBrand=document.getElementById("modalBrand");
  const modalType=document.getElementById("modalType");
  const modalDmoCode=document.getElementById("modalDmoCode");
  const modalPrice=document.getElementById("modalPrice");
  const modalPriceSub=document.getElementById("modalPriceSub");
  const modalDesc=document.getElementById("modalDesc");
  const modalDmo=document.getElementById("modalDmo");
  const thumbsEl=document.getElementById("thumbs");
  const btnClose=document.getElementById("modalClose");
  const viewerBox=document.querySelector(".viewer");

  let modalPhotos = [];
  let modalIndex  = 0;

  const setMain = (src, btn)=>{
    if(src){ modalMain.src=src; modalMain.alt="Ürün görseli"; withFallback(modalMain); }
    else   { modalMain.removeAttribute("src"); modalMain.alt=""; }
    Array.prototype.forEach.call(thumbsEl.children, el=>el.classList.remove("active"));
    if(btn) btn.classList.add("active");
  };

  function openOverlay(){ overlay.classList.add("is-open"); overlay.removeAttribute("hidden"); document.body.style.overflow="hidden"; }
  function closeGallery(){ overlay.classList.remove("is-open"); overlay.setAttribute("hidden",""); document.body.style.overflow=""; }

  function openGallery(item){
    modalTtl.textContent=item.title;
    modalBrand.innerHTML=item.brand?`<span class="label">Marka:</span>${item.brand}`:"";
    modalType.innerHTML=item.type?`<span class="label">Cinsi:</span><span class="emph">${item.type}</span>`:"";
    modalDmoCode.innerHTML=item.dmoCode?`<span class="label">DMO Kodu:</span><span class="code">${item.dmoCode}</span>`:"";

    const f1=item.price?fmtTRY(item.price):""; const f2=item.priceKdv?fmtTRY(item.priceKdv):"";
    modalPrice.textContent=f1||""; modalPriceSub.textContent=f2?`KDV Dahil: ${f2}`:"";
    modalDesc.textContent=item.desc||"";
    if(item.dmo){ modalDmo.href=item.dmo; modalDmo.hidden=false; } else { modalDmo.hidden=true; }

    thumbsEl.innerHTML="";
    modalPhotos=(item.photos||[]).filter(Boolean);
    modalIndex=0;
    if(modalPhotos.length){
      setMain(modalPhotos[0], null);
      modalPhotos.forEach((src,i)=>{
        const t=document.createElement("button"); t.type="button"; t.className="thumb";
        const im=document.createElement("img"); im.src=src; withFallback(im);
        t.appendChild(im);
        t.addEventListener("click",()=>{ modalIndex=i; setMain(src,t); });
        thumbsEl.appendChild(t);
      });
      if(thumbsEl.firstElementChild) thumbsEl.firstElementChild.classList.add("active");
    }else{
      setMain("", null); thumbsEl.innerHTML='<div class="thumb thumb--empty">Fotoğraf yok</div>';
    }

    openOverlay();
  }

  // Büyük görsel tıklanınca sonraki fotoğrafa geç
  viewerBox.addEventListener('click', ()=>{
    if(!modalPhotos.length) return;
    modalIndex = (modalIndex + 1) % modalPhotos.length;
    const btn = thumbsEl.children[modalIndex];
    setMain(modalPhotos[modalIndex], btn);
  });

  btnClose.addEventListener("click", closeGallery);
  overlay.addEventListener("click", (e)=>{ if(e.target===overlay) closeGallery(); });
  document.addEventListener("keydown", (e)=>{ if(!overlay.hidden && e.key==="Escape") closeGallery(); });

  // Başlat
  (async function init(){
    try{
      ALL_ITEMS = await fetchCSV();
      wireUI(ALL_ITEMS);
      update();
    }catch(err){
      console.error(err);
      const dbg=document.getElementById("debugBox");
      dbg.hidden=false;
      dbg.innerHTML=`Ürünler yüklenemedi.<br><small style="color:#6b7280">Hata: ${String(err.message||err).replace(/</g,'&lt;')}</small><div style="margin-top:6px"><a target="_blank" href="${CSV_URL}">CSV test</a></div>`;
      document.getElementById("productEmpty").hidden=false;
    }
  })();
</script>
</body>
</html>
